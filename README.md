# Nx Migrate Action Demo

This repository demonstrates how to set up automated Nx migrations using the [`gridatek/nx-migrate-action`](https://github.com/gridatek/nx-migrate-action) GitHub Action with auto-merge capabilities.

## ðŸš€ Quick Setup Guide

Follow these steps to create your own Nx workspace with automated migrations:

### Step 1: Create a New Nx Workspace

```bash
# Create a new Nx workspace
npx create-nx-workspace@latest my-nx-workspace --preset=ts --packageManager=npm

# Navigate to your workspace
cd my-nx-workspace

# Initialize git repository
git init
git add .
git commit -m "Initial commit"
```

### Step 2: Set Up GitHub Repository

1. Create a new repository on GitHub
2. Push your local workspace to GitHub:

```bash
git remote add origin https://github.com/your-username/my-nx-workspace.git
git branch -M main
git push -u origin main
```

### Step 3: Configure Branch Protection (Recommended)

Here's how to protect your main branch using GitHub Actions:

#### Navigate to Settings
1. Go to your repository on GitHub
2. Click **Settings** â†’ **Branches**

#### Add Branch Protection Rule
1. Click "Add branch protection rule"
2. Enter `main` (or your default branch name) in the branch name pattern

#### Key Protection Settings

**Require pull requests before merging**
- âœ… Check "Require a pull request before merging"
- Set required number of reviewers (recommended: at least 1)
- âœ… Enable "Dismiss stale reviews when new commits are pushed"

**Require status checks to pass**
- âœ… Check "Require status checks to pass before merging"
- âœ… Check "Require branches to be up to date before merging"
- Add your GitHub Actions workflow jobs as required status checks (e.g., `main` from your CI workflow)

**Additional protections**
- âœ… Check "Require conversation resolution before merging"
- âœ… Check "Restrict pushes that create files"
- âœ… Check "Do not allow bypassing the above settings" (removes admin override)

> **Important**: These settings ensure that all code changes go through the proper review process and that your CI checks pass before any code is merged into the main branch.

### Step 4: Configure Dependabot (Optional)

Dependabot automatically creates pull requests for dependency updates. While the Nx Migration Action handles Nx-specific updates, Dependabot can manage other dependencies.

Create `.github/dependabot.yml`:

```yaml
version: 2
updates:
  # Enable version updates for npm
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
    open-pull-requests-limit: 10
    reviewers:
      - "your-username"  # Replace with your GitHub username
    assignees:
      - "your-username"  # Replace with your GitHub username
    commit-message:
      prefix: "deps"
      include: "scope"
    # Ignore Nx dependencies - let nx-migrate-action handle these
    ignore:
      - dependency-name: "@nx/*"
      - dependency-name: "nx"
      - dependency-name: "@nrwl/*"
    # Group dependency updates to reduce PR noise
    groups:
      dev-dependencies:
        patterns:
          - "@types/*"
          - "*eslint*"
          - "*prettier*"
          - "*jest*"
          - "*typescript*"

  # Enable version updates for GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
```

> **Note**: This configuration excludes major Nx updates since the `nx-migrate-action` handles those with proper migrations. Dependabot will only handle patch updates for Nx packages and other non-Nx dependencies.

### Step 5: Add Nx Migration Workflow

Create `.github/workflows/nx-migrate.yml`:

```yaml
name: Nx Migration
on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'  # Daily at 1 AM

jobs:
  nx-migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: gridatek/nx-migrate-action@v0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
```

### Step 6: Add CI Workflow

Create `.github/workflows/ci.yml` (or use the one generated by Nx when creating your workspace):

```yaml
name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci --legacy-peer-deps
      - run: npx nx run-many -t lint test build typecheck
```

> **Note**: If you created your Nx workspace with `create-nx-workspace`, it may have already generated a CI workflow for you. You can use that instead of creating a new one.

### Step 7: Add Auto-merge Workflow (Optional)

Create `.github/workflows/auto-merge-nx-prs.yml`:

```yaml
name: Auto-merge Nx Migration PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]
  status: {}

jobs:
  auto-merge:
    name: Auto-merge Nx Migration PR
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login == 'github-actions[bot]' &&
      contains(github.event.pull_request.labels.*.name, 'nx-migrate-action')

    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: Wait for CI checks
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-checks
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 1800 # 30 minutes

      - name: Auto-merge PR
        if: steps.wait-for-checks.outputs.conclusion == 'success'
        uses: pascalgn/merge-action@v0.15.6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash
```


## ðŸŽ¯ How It Works

1. **Daily Check**: The migration workflow runs daily at 1 AM
2. **Version Detection**: Checks for new Nx versions
3. **Migration**: Automatically runs `nx migrate` if updates are available
4. **PR Creation**: Creates a pull request with migration changes
5. **CI Validation**: Your existing CI workflow (generated by Nx or custom) validates the changes
6. **Auto-merge**: If CI passes, the PR is automatically merged (if enabled)

## ðŸ“š Learn More About This Setup

### Advanced Configuration

The `nx-migrate-action` supports additional configuration options:

```yaml
- uses: gridatek/nx-migrate-action@v0
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    package-manager: npm  # or yarn, pnpm
    pr-labels: nx-migrate-action,dependencies  # Custom labels
    target-branch: main  # Target branch for PRs
    dev-mode: false  # Enable for testing
```

### Migration Schedules

Choose the schedule that fits your team:

- **Daily** (`'0 1 * * *'`): Aggressive, get updates immediately
- **Weekly** (`'0 1 * * 1'`): Recommended for most teams
- **Monthly** (`'0 1 1 * *'`): Conservative approach


## ðŸŽ‰ Benefits of Automated Nx Migrations

- **Stay Current**: Always running the latest Nx version with security patches
- **Reduce Manual Work**: No more remembering to check for updates
- **Team Consistency**: Everyone works with the same Nx version
- **CI Integration**: Changes are validated before merging
- **Safe Migrations**: Review process through pull requests

## ðŸ”§ Troubleshooting

### Common Issues

1. **Migration fails**: Check the PR for migration errors and fix manually
2. **Auto-merge not working**: Ensure branch protection rules allow the bot to merge
3. **CI fails**: Migration might introduce breaking changes requiring manual fixes
4. **No CI workflow**: If Nx didn't generate a CI workflow, create one following Step 4 above

### Manual Override

You can always run migrations manually:

```bash
npx nx migrate latest
npx nx migrate --run-migrations
```

---

## ðŸš€ About nx-migrate-action

This demo uses the [`gridatek/nx-migrate-action`](https://github.com/gridatek/nx-migrate-action) GitHub Action.

- **GitHub Repository**: [gridatek/nx-migrate-action](https://github.com/gridatek/nx-migrate-action)
- **GitHub Marketplace**: [Nx Migration Action](https://github.com/marketplace/actions/nx-migration)
- **Issues & Support**: [Report issues](https://github.com/gridatek/nx-migrate-action/issues)

### Contributing

Found a bug or have a feature request? Please [open an issue](https://github.com/gridatek/nx-migrate-action/issues) or submit a pull request!
